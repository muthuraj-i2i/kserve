name: Go Test

on:
    push:
        branches: [master, release*]
    pull_request:
        branches: []
    workflow_dispatch:

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

permissions:
    contents: write
    pull-requests: write

jobs:
    test-others:
        name: Test Others
        runs-on: ubuntu-latest
        steps:

            - name: Check out code into the Go module directory
              uses: actions/checkout@v4

            - name: Set up Go 1.x
              uses: actions/setup-go@v5
              with:
               go-version-file: go.mod
              id: go

            - name: Get dependencies
              run: |
                go get -v -t -d ./...

            - name: Test Others
              id: test
              run: |
                export GOPATH=/home/runner/go
                export PATH=$PATH:/usr/local/kubebuilder/bin:/home/runner/go/bin
                wget -O $GOPATH/bin/yq https://github.com/mikefarah/yq/releases/download/v4.28.1/yq_linux_amd64
                chmod +x $GOPATH/bin/yq
                make test-others
                ./coverage.sh
                echo ::set-output name=coverage::$(./coverage.sh | tr -s '\t' | cut -d$'\t' -f 3)
            
            - name: Print coverage
              run: |
                echo "Coverage output is ${{ steps.test.outputs.coverage }}"

            - name: upload cover profile artifact
              uses: actions/upload-artifact@v4
              with:
                name: coverage-others.out
                path: coverage-others.out
                if-no-files-found: error

    test-controller:
        name: Test Controller
        runs-on: ubuntu-latest
        steps:

            - name: Check out code into the Go module directory
              uses: actions/checkout@v4

            - name: Set up Go 1.x
              uses: actions/setup-go@v5
              with:
               go-version-file: go.mod
              id: go

            - name: Get dependencies
              run: |
                go get -v -t -d ./...

            - name: Test Controller
              id: test
              run: |
                export GOPATH=/home/runner/go
                export PATH=$PATH:/usr/local/kubebuilder/bin:/home/runner/go/bin
                wget -O $GOPATH/bin/yq https://github.com/mikefarah/yq/releases/download/v4.28.1/yq_linux_amd64
                chmod +x $GOPATH/bin/yq
                make test-controller
            
            - name: upload cover profile artifact
              uses: actions/upload-artifact@v4
              with:
                name: coverage-controller.out
                path: coverage-controller.out
                if-no-files-found: error

    test-rawkube:
        name: Test Rawkube
        runs-on: ubuntu-latest
        steps:

            - name: Check out code into the Go module directory
              uses: actions/checkout@v4

            - name: Set up Go 1.x
              uses: actions/setup-go@v5
              with:
               go-version-file: go.mod
              id: go

            - name: Get dependencies
              run: |
                go get -v -t -d ./...

            - name: Test Rawkube
              id: test
              run: |
                export GOPATH=/home/runner/go
                export PATH=$PATH:/usr/local/kubebuilder/bin:/home/runner/go/bin
                wget -O $GOPATH/bin/yq https://github.com/mikefarah/yq/releases/download/v4.28.1/yq_linux_amd64
                chmod +x $GOPATH/bin/yq
                make test-rawkube
            
            - name: upload cover profile artifact
              uses: actions/upload-artifact@v4
              with:
                name: coverage-rawkube.out
                path: coverage-rawkube.out
                if-no-files-found: error

    check-coverage:
        needs: [test-others, test-controller, test-rawkube]
        runs-on: ubuntu-latest
        name: Check Coverage
        steps:
            - name: checkout
              uses: actions/checkout@v4

            - name: Download coverage artifacts
              uses: actions/download-artifact@v4
              with:
                pattern: coverage-*.out
                merge-multiple: true

            - name: Combine coverage reports
              id: combine-coverage
              run: |
                # Make merge script executable
                chmod +x ./merge-coverage.sh
                
                # List downloaded files for debugging
                echo "Downloaded files:"
                ls -la *.out || echo "No .out files found"
                
                # Check file sizes and validity
                echo "Checking coverage file validity:"
                for file in coverage-others.out coverage-controller.out coverage-rawkube.out; do
                  if [ -f "$file" ]; then
                    size=$(wc -l < "$file")
                    echo "âœ“ $file found ($size lines)"
                    # Show first few lines to verify format
                    echo "  First line: $(head -n1 "$file")"
                    if [ "$size" -gt 1 ]; then
                      echo "  Sample data: $(head -n2 "$file" | tail -n1)"
                    fi
                  else
                    echo "âœ— $file not found"
                  fi
                done
                
                # Count valid coverage files
                valid_files=()
                [ -f coverage-others.out ] && [ $(wc -l < coverage-others.out) -gt 1 ] && valid_files+=(coverage-others.out)
                [ -f coverage-controller.out ] && [ $(wc -l < coverage-controller.out) -gt 1 ] && valid_files+=(coverage-controller.out)
                [ -f coverage-rawkube.out ] && [ $(wc -l < coverage-rawkube.out) -gt 1 ] && valid_files+=(coverage-rawkube.out)
                
                echo "Found ${#valid_files[@]} valid coverage files: ${valid_files[*]}"
                
                # Merge coverage files using the improved script
                if [ ${#valid_files[@]} -gt 1 ]; then
                  echo "Merging ${#valid_files[@]} coverage files..."
                  ./merge-coverage.sh coverage.out "${valid_files[@]}"
                  if [ $? -eq 0 ]; then
                    echo "Successfully merged coverage files"
                  else
                    echo "Error: Coverage merge failed"
                    exit 1
                  fi
                elif [ ${#valid_files[@]} -eq 1 ]; then
                  echo "Using single coverage file: ${valid_files[0]}"
                  cp "${valid_files[0]}" coverage.out
                else
                  echo "No valid coverage files found, creating minimal coverage file"
                  echo "mode: set" > coverage.out
                fi
                
                # Verify the merged file
                if [ -f coverage.out ]; then
                  lines=$(wc -l < coverage.out)
                  echo "Final coverage.out contains $lines lines"
                  if [ $lines -gt 1 ]; then
                    echo "Coverage file header: $(head -n1 coverage.out)"
                    echo "Sample coverage data: $(head -n3 coverage.out | tail -n1)"
                    echo "Coverage file appears valid"
                  else
                    echo "Warning: Coverage file contains only header"
                  fi
                else
                  echo "Error: Failed to create coverage.out"
                  exit 1
                fi

            - name: Extract coverage percentage
              id: current-coverage
              run: |
                if [ -f coverage.out ] && [ $(wc -l < coverage.out) -gt 1 ]; then
                  echo "Calculating coverage from coverage.out..."
                  # Use go tool cover to get accurate coverage percentage
                  COVERAGE_OUTPUT=$(go tool cover -func=coverage.out 2>/dev/null || echo "")
                  if [ -n "$COVERAGE_OUTPUT" ]; then
                    COVERAGE=$(echo "$COVERAGE_OUTPUT" | grep "total:" | awk '{print $3}' | sed 's/%//')
                    if [ -n "$COVERAGE" ] && [ "$COVERAGE" != "" ]; then
                      echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
                      echo "Extracted coverage: $COVERAGE%"
                    else
                      echo "coverage=0" >> $GITHUB_OUTPUT
                      echo "Warning: Could not extract coverage percentage from go tool cover output"
                    fi
                  else
                    echo "coverage=0" >> $GITHUB_OUTPUT
                    echo "Warning: go tool cover failed to process coverage.out"
                  fi
                else
                  echo "coverage=0" >> $GITHUB_OUTPUT
                  echo "Warning: coverage.out not found or empty"
                fi
            
            - name: download artifact (master.breakdown)
              id: download-master-breakdown
              uses: dawidd6/action-download-artifact@v9
              with:
                branch: master
                workflow_conclusion: success
                name: master.breakdown
                if_no_artifact_found: warn

            - name: download artifact (master-coverage.out)
              id: download-master-coverage
              uses: dawidd6/action-download-artifact@v9
              with:
                branch: master
                workflow_conclusion: success
                name: master-coverage.out
                if_no_artifact_found: warn

            - name: Extract master coverage percentage
              id: master-coverage
              run: |
                if [ -f master-coverage.out ] && [ $(wc -l < master-coverage.out) -gt 1 ]; then
                  echo "Calculating master coverage from master-coverage.out..."
                  COVERAGE_OUTPUT=$(go tool cover -func=master-coverage.out 2>/dev/null || echo "")
                  if [ -n "$COVERAGE_OUTPUT" ]; then
                    MASTER_COVERAGE=$(echo "$COVERAGE_OUTPUT" | grep "total:" | awk '{print $3}' | sed 's/%//')
                    if [ -n "$MASTER_COVERAGE" ] && [ "$MASTER_COVERAGE" != "" ]; then
                      echo "coverage=$MASTER_COVERAGE" >> $GITHUB_OUTPUT
                      echo "Extracted master coverage: $MASTER_COVERAGE%"
                    else
                      echo "coverage=0" >> $GITHUB_OUTPUT
                      echo "Warning: Could not extract master coverage percentage"
                    fi
                  else
                    echo "coverage=0" >> $GITHUB_OUTPUT
                    echo "Warning: go tool cover failed to process master-coverage.out"
                  fi
                else
                  echo "coverage=0" >> $GITHUB_OUTPUT
                  echo "Warning: master-coverage.out not found or empty"
                fi

            - name: Generate full coverage breakdown
              id: full_coverage_report
              run: |
                if [ -f coverage.out ] && [ $(wc -l < coverage.out) -gt 1 ]; then
                  echo "Generating coverage breakdown..."
                  REPORT_CONTENT=$(go tool cover -func=coverage.out 2>/dev/null || echo "Error: Failed to generate coverage report")
                  if [ "$REPORT_CONTENT" != "Error: Failed to generate coverage report" ] && [ -n "$REPORT_CONTENT" ]; then
                    echo "report<<EOF" >> $GITHUB_OUTPUT
                    echo "$REPORT_CONTENT" >> $GITHUB_OUTPUT
                    echo "EOF" >> $GITHUB_OUTPUT
                  else
                    echo "report=Error: Unable to generate coverage breakdown from coverage.out" >> $GITHUB_OUTPUT
                  fi
                else
                  echo "report=No coverage report found or coverage file is empty." >> $GITHUB_OUTPUT
                fi

            - name: check test coverage
              id: coverage
              uses: vladopajic/go-test-coverage@v2
              continue-on-error: true
              with:
                config: ./.github/.testcoverage.yml
                breakdown-file-name: ${{ github.ref_name == 'master' && 'master.breakdown' || '' }}
                diff-base-breakdown-file-name: ${{ steps.download-master-breakdown.outputs.found_artifact == 'true' && 'master.breakdown' || '' }}
            
            - name: upload artifact (master.breakdown)
              uses: actions/upload-artifact@v4
              if: github.ref_name == 'master'
              with:
                name: master.breakdown
                path: master.breakdown
                if-no-files-found: error
                
            - name: Previous coverage
              run: |
                echo "Previous Coverage ${{ steps.master-coverage.outputs.coverage }}"

            - name: Current coverage
              run: |
                echo "Current Coverage ${{ steps.current-coverage.outputs.coverage }}"

            - name: post coverage report
              # this has evalated permission to post back the coverage, only restricted to this step.
              if: github.event_name == 'pull_request_target'
              uses: thollander/actions-comment-pull-request@v3
              with:
                github-token: ${{ secrets.GITHUB_TOKEN }}
                comment-tag: coverage-report
                pr-number: ${{ github.event.pull_request.number }}
                message: |
                  ## ðŸ“Š Go Test Coverage Report

                  ${{ 
                    steps.current-coverage.outputs.coverage > steps.master-coverage.outputs.coverage 
                    && 'âœ… **Overall code coverage increased.**' 
                    || steps.current-coverage.outputs.coverage < steps.master-coverage.outputs.coverage 
                    && 'âŒ **Overall code coverage decreased.**' 
                    || 'â„¹ï¸ **Overall code coverage unchanged.**' 
                  }}

                  **ðŸ” Coverage Summary**
                  - **Pull Request Coverage:** `${{ steps.current-coverage.outputs.coverage }}%`
                  - **Main Branch Coverage:** `${{ steps.master-coverage.outputs.coverage }}%`

                  <details>
                  <summary>ðŸ“„ Click to expand full coverage breakdown</summary>

                  ```
                  ${{ steps.full_coverage_report.outputs.report }}
                  ```

                  </details>

            - name: Rename and upload master coverage
              if: github.ref_name == 'master'
              run: mv coverage.out master-coverage.out

            - name: Upload master coverage artifact
              if: github.ref_name == 'master'
              uses: actions/upload-artifact@v4
              with:
                name: master-coverage.out
                path: master-coverage.out
                if-no-files-found: error